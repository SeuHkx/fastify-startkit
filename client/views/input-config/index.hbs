<!-- auto scaffolded from config: input-config -->
<section class="main-content-box--container" x-data="inputConfig">

  <!-- 加载中状态 -->
  <div x-show="isLoading" class="has-text-centered py-6">
    <div class="loader is-inline-block"></div>
  </div>

  <!-- 主要内容 -->
  <div x-show="!isLoading">
    <!-- 页面操作区域 -->
    <div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
      <div class="buttons">
        <button 
          class="button is-primary" 
          @click="addDevice"
          x-show="!isAdding && !isEditing"
        >
          <span>添加输入点</span>
        </button>
        <button 
          class="button is-danger" 
          @click="deleteSelected"
          x-show="!isAdding && !isEditing"
        >
          <span>删除选中</span>
        </button>
      </div>
    </div>

    <!-- 添加表单 -->
    <div x-show="isAdding" class="box mb-5">
      <h2 class="subtitle is-5">添加新输入点</h2>
      <div class="columns">
        <div class="column is-4">
          <div class="field">
            <label class="label">通道名称</label>
            <div class="control">
              <input 
                x-model="addForm.channel" 
                @input="validateField('channel', addForm)"
                class="input" 
                type="text" 
                placeholder="例如: DI0, DI1"
                :class="{ 'is-danger': errors.channel }"
              >
            </div>
            <p x-show="errors.channel" class="help is-danger" x-text="errors.channel"></p>
          </div>
        </div>
        <div class="column is-4">
          <div class="field">
            <label class="label">关联设备</label>
            <div class="control">
              <input 
                x-model="addForm.device" 
                @input="validateField('device', addForm)"
                class="input" 
                type="text" 
                placeholder="请输入或选择设备"
                list="devices-list"
                :class="{ 'is-danger': errors.device }"
              >
              <datalist id="devices-list">
                <template x-for="device in availableDevices" :key="device.name">
                  <option :value="device.name" x-text="`${device.name} (${device.type})`"></option>
                </template>
              </datalist>
            </div>
            <p x-show="errors.device" class="help is-danger" x-text="errors.device"></p>
          </div>
        </div>
        <div class="column is-2">
          <div class="field">
            <label class="label">状态值</label>
            <div class="control">
              <input 
                x-model.number="addForm.status" 
                @input="validateField('status', addForm)"
                class="input" 
                type="number" 
                placeholder="0"
                :class="{ 'is-danger': errors.status }"
              >
            </div>
            <p x-show="errors.status" class="help is-danger" x-text="errors.status"></p>
          </div>
        </div>
        <div class="column is-2">
          <div class="field">
            <label class="label">&nbsp;</label>
            <div class="control">
              <div class="buttons">
                <button 
                  class="button is-success"
                  @click="confirmAdd"
                  :disabled="!isFormValid"
                >
                  确认
                </button>
                <button 
                  class="button is-light"
                  @click="cancelAdd"
                >
                  取消
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 数据表格 -->
    <div class="table-container">
      <table class="table is-fullwidth is-hoverable">
        <thead>
          <tr class="has-background-light">
            <th style="width: 40px;">
              <label class="checkbox">
                <input type="checkbox" @change="toggleSelectAll" :disabled="isAdding || isEditing">
              </label>
            </th>
            <th>通道名称</th>
            <th>关联设备</th>
            <th>状态值</th>
            <th style="width: 180px;">操作</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(digitalInput, index) in paginatedDigitalInputs" :key="digitalInput.channel">
            <tr>
              <td>
                <label class="checkbox">
                  <input 
                    type="checkbox" 
                    x-model="digitalInput.selected"
                    :disabled="isAdding || isEditing"
                  >
                </label>
              </td>
              <td>
                <template x-if="isEditing && editingIndex === ((currentPage - 1) * pageSize + index)">
                  <div class="field">
                    <div class="control">
                      <input 
                        x-model="editForm.channel" 
                        @input="validateField('channel', editForm)"
                        class="input is-small" 
                        type="text"
                        :class="{ 'is-danger': errors.channel }"
                      >
                    </div>
                    <p x-show="errors.channel" class="help is-danger is-size-7" x-text="errors.channel"></p>
                  </div>
                </template>
                <template x-if="!isEditing || editingIndex !== ((currentPage - 1) * pageSize + index)">
                  <span x-text="digitalInput.channel"></span>
                </template>
              </td>
              <td>
                <template x-if="isEditing && editingIndex === ((currentPage - 1) * pageSize + index)">
                  <div class="field">
                    <div class="control">
                      <input 
                        x-model="editForm.device" 
                        @input="validateField('device', editForm)"
                        class="input is-small" 
                        type="text"
                        placeholder="请输入或选择设备"
                        list="devices-list-edit"
                        :class="{ 'is-danger': errors.device }"
                      >
                      <datalist id="devices-list-edit">
                        <template x-for="device in availableDevices" :key="device.name">
                          <option :value="device.name" x-text="`${device.name} (${device.type})`"></option>
                        </template>
                      </datalist>
                    </div>
                    <p x-show="errors.device" class="help is-danger is-size-7" x-text="errors.device"></p>
                  </div>
                </template>
                <template x-if="!isEditing || editingIndex !== ((currentPage - 1) * pageSize + index)">
                  <span x-text="digitalInput.device"></span>
                </template>
              </td>
              <td>
                <template x-if="isEditing && editingIndex === ((currentPage - 1) * pageSize + index)">
                  <div class="field">
                    <div class="control">
                      <input 
                        x-model.number="editForm.status" 
                        @input="validateField('status', editForm)"
                        class="input is-small" 
                        type="number"
                        :class="{ 'is-danger': errors.status }"
                      >
                    </div>
                    <p x-show="errors.status" class="help is-danger is-size-7" x-text="errors.status"></p>
                  </div>
                </template>
                <template x-if="!isEditing || editingIndex !== ((currentPage - 1) * pageSize + index)">
                  <span class="tag"  x-text="digitalInput.status"></span>
                </template>
              </td>
              <td>
                <template x-if="isEditing && editingIndex === ((currentPage - 1) * pageSize + index)">
                  <div class="buttons is-centered are-small">
                    <button 
                      class="button is-success is-small"
                      @click="confirmEdit"
                      :disabled="!isFormValid"
                    >
                      确认
                    </button>
                    <button 
                      class="button is-light is-small"
                      @click="cancelEdit"
                    >
                      取消
                    </button>
                  </div>
                </template>
                <template x-if="!isEditing || editingIndex !== ((currentPage - 1) * pageSize + index)">
                  <div class="buttons is-centered are-small">
                    <button 
                      class="button is-info is-small"
                      @click="editDevice(index)"
                      :disabled="isAdding || isEditing"
                    >
                      编辑
                    </button>
                    <button 
                      class="button is-danger is-small"
                      @click="deleteDevice(index)"
                      :disabled="isAdding || isEditing"
                    >
                      删除
                    </button>
                  </div>
                </template>
              </td>
            </tr>
          </template>
          <tr x-show="digitalInputs.length === 0">
            <td colspan="5" class="has-text-centered py-6">
              <div class="content">
                <p class="has-text-grey">暂无数字输入配置</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 分页 -->
    <div class="pagination-container is-flex is-justify-content-flex-end is-align-items-center mt-4" x-show="totalPages > 1">
      <div class="pagination-controls is-flex is-align-items-center is-flex-wrap-wrap" style="gap: 1rem;">
        <!-- 总数和每页条数 -->
        <div class="pagination-info is-flex is-align-items-center" style="gap: 0.5rem;">
          <span>共 <span x-text="totalItems"></span> 条</span>
          <span>每页</span>
          <div class="select is-small">
            <select x-model="pageSize">
              <option>20</option>
              <option>50</option>
              <option>100</option>
            </select>
          </div>
          <span>条</span>
        </div>

        <!-- 分页导航 -->
        <nav class="pagination is-small is-centered" role="navigation" aria-label="pagination" style="margin: 0;">
          <a class="pagination-previous" @click="prevPage" :disabled="currentPage === 1">上一页</a>
          <a class="pagination-next" @click="nextPage" :disabled="currentPage === totalPages">下一页</a>
          <ul class="pagination-list">
            <template x-for="page in paginationItems" :key="page.value">
              <li>
                <template x-if="page.type === 'page'">
                  <a class="pagination-link" :class="{ 'is-current': page.value === currentPage }" @click="goToPage(page.value)" x-text="page.value"></a>
                </template>
                <template x-if="page.type === 'ellipsis'">
                  <span class="pagination-ellipsis">&hellip;</span>
                </template>
              </li>
            </template>
          </ul>
        </nav>

        <!-- 跳转页面 -->
        <div class="pagination-goto is-flex is-align-items-center" style="gap: 0.5rem;">
          <span>前往</span>
          <input class="input is-small" style="width: 60px;" type="number" min="1" :max="totalPages" x-model="goToPageInput">
          <span>页</span>
          <button class="button is-small" @click="goToPage(goToPageInput)">确定</button>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.field .help.is-size-7 {
  font-size: 0.75rem;
}
</style>
