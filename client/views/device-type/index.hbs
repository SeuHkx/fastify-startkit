{{!-- auto scaffolded page template (HBS) for device-type --}}
<div class="main-content-box--container" x-data="deviceType">
    <div x-show="!isLoading">
    <!-- 操作按钮 -->
    <div class="buttons mb-3">
      <button class="button is-primary" @click="addDevice" :disabled="isEditing || isAdding">
        <span>添加设备</span>
      </button>
      <button class="button is-danger" @click="deleteSelected" :disabled="isEditing || isAdding">
        <span>删除选中</span>
      </button>
    </div>
    
    <!-- 添加设备表单 -->
    <div x-show="isAdding" class="box mb-4">
      <h4 class="title is-5">添加新设备</h4>
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">设备名称</label>
            <div class="control">
              <input class="input" :class="{ 'is-danger': errors.name }" type="text" placeholder="请输入设备名称" x-model="addForm.name" @blur="validateField('name', addForm)" @input="errors.name = ''">
            </div>
            <p x-show="errors.name" class="help is-danger" x-text="errors.name"></p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">设备类型</label>
            <div class="control">
              <input class="input" :class="{ 'is-danger': errors.type }" type="text" placeholder="请输入设备类型" x-model="addForm.type" @blur="validateField('type', addForm)" @input="errors.type = ''">
            </div>
            <p x-show="errors.type" class="help is-danger" x-text="errors.type"></p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">输入点数</label>
            <div class="control">
              <input class="input" :class="{ 'is-danger': errors.DINum }" type="number" min="0" placeholder="0" x-model.number="addForm.DINum" @blur="validateField('DINum', addForm)" @input="errors.DINum = ''">
            </div>
            <p x-show="errors.DINum" class="help is-danger" x-text="errors.DINum"></p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">输出点数</label>
            <div class="control">
              <input class="input" :class="{ 'is-danger': errors.DONum }" type="number" min="0" placeholder="0" x-model.number="addForm.DONum" @blur="validateField('DONum', addForm)" @input="errors.DONum = ''">
            </div>
            <p x-show="errors.DONum" class="help is-danger" x-text="errors.DONum"></p>
          </div>
        </div>
      </div>
      <div class="field is-grouped">
        <div class="control">
          <button class="button is-primary" @click="confirmAdd" :disabled="!isFormValid">确认添加</button>
        </div>
        <div class="control">
          <button class="button" @click="cancelAdd">取消</button>
        </div>
      </div>
    </div>
    
    <div class="table-container">
      <table class="table is-fullwidth is-hoverable">
        <thead>
          <tr class="has-background-light">
            <th style="width: 40px;">
              <label class="checkbox">
                <input type="checkbox" @click="toggleSelectAll" :disabled="isEditing || isAdding">
              </label>
            </th>
            <th>设备名称</th>
            <th>设备类型</th>
            <th>输入点数</th>
            <th>输出点数</th>
            <th style="width: 180px;">操作</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(device, index) in devices" :key="device.name">
            <tr>
              <td>
                <label class="checkbox">
                  <input type="checkbox" x-model="device.selected" :disabled="isEditing || isAdding">
                </label>
              </td>
              
              <!-- 编辑模式 -->
              <template x-if="isEditing && editingIndex === (currentPage - 1) * pageSize + index">
                <td>
                  <input class="input is-small" :class="{ 'is-danger': errors.name }" type="text" x-model="editForm.name" @blur="validateField('name', editForm)" @input="errors.name = ''">
                  <p x-show="errors.name" class="help is-danger is-size-7" x-text="errors.name"></p>
                </td>
              </template>
              <template x-if="!(isEditing && editingIndex === (currentPage - 1) * pageSize + index)">
                <td x-text="device.name"></td>
              </template>
              
              <template x-if="isEditing && editingIndex === (currentPage - 1) * pageSize + index">
                <td>
                  <input class="input is-small" :class="{ 'is-danger': errors.type }" type="text" x-model="editForm.type" @blur="validateField('type', editForm)" @input="errors.type = ''">
                  <p x-show="errors.type" class="help is-danger is-size-7" x-text="errors.type"></p>
                </td>
              </template>
              <template x-if="!(isEditing && editingIndex === (currentPage - 1) * pageSize + index)">
                <td x-text="device.type"></td>
              </template>
              
              <template x-if="isEditing && editingIndex === (currentPage - 1) * pageSize + index">
                <td>
                  <input class="input is-small" :class="{ 'is-danger': errors.DINum }" type="number" min="0" x-model.number="editForm.DINum" @blur="validateField('DINum', editForm)" @input="errors.DINum = ''">
                  <p x-show="errors.DINum" class="help is-danger is-size-7" x-text="errors.DINum"></p>
                </td>
              </template>
              <template x-if="!(isEditing && editingIndex === (currentPage - 1) * pageSize + index)">
                <td x-text="device.DINum"></td>
              </template>
              
              <template x-if="isEditing && editingIndex === (currentPage - 1) * pageSize + index">
                <td>
                  <input class="input is-small" :class="{ 'is-danger': errors.DONum }" type="number" min="0" x-model.number="editForm.DONum" @blur="validateField('DONum', editForm)" @input="errors.DONum = ''">
                  <p x-show="errors.DONum" class="help is-danger is-size-7" x-text="errors.DONum"></p>
                </td>
              </template>
              <template x-if="!(isEditing && editingIndex === (currentPage - 1) * pageSize + index)">
                <td x-text="device.DONum"></td>
              </template>
              
              <td>
                <div class="buttons is-centered are-small">
                  <!-- 编辑模式按钮 -->
                  <template x-if="isEditing && editingIndex === (currentPage - 1) * pageSize + index">
                    <button class="button is-success is-small" @click="confirmEdit" :disabled="!isFormValid">
                      <span>确认</span>
                    </button>
                  </template>
                  <template x-if="isEditing && editingIndex === (currentPage - 1) * pageSize + index">
                    <button class="button is-small" @click="cancelEdit">
                      <span>取消</span>
                    </button>
                  </template>
                  
                  <!-- 普通模式按钮 -->
                  <template x-if="!(isEditing && editingIndex === (currentPage - 1) * pageSize + index)">
                    <button class="button is-info is-small" @click="editDevice(index)" :disabled="isEditing || isAdding">
                      <span>编辑</span>
                    </button>
                  </template>
                  <template x-if="!(isEditing && editingIndex === (currentPage - 1) * pageSize + index)">
                    <button class="button is-danger is-small" @click="deleteDevice(index)" :disabled="isEditing || isAdding">
                      <span>删除</span>
                    </button>
                  </template>
                </div>
              </td>
            </tr>
          </template>
          
          <!-- 空状态 -->
          <template x-if="devices.length === 0">
            <tr>
              <td colspan="6" class="has-text-centered has-text-grey">
                <div class="py-4">
                  <p>暂无设备数据</p>
                  <button class="button is-primary is-small mt-2" @click="addDevice">添加第一个设备</button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
    
    <!-- 分页 -->
    <div x-show="totalPages > 1" class="pagination-container is-flex is-justify-content-flex-end is-align-items-center mt-4">
      <div class="pagination-controls is-flex is-align-items-center is-flex-wrap-wrap" style="gap: 1rem;">
        <!-- 总数和每页条数 -->
        <div class="pagination-info is-flex is-align-items-center" style="gap: 0.5rem;">
          <span>共 <span x-text="totalItems"></span> 条</span>
          <span>每页</span>
          <div class="select is-small">
            <select x-model="pageSize">
              <option>20</option>
              <option>50</option>
              <option>100</option>
            </select>
          </div>
          <span>条</span>
        </div>

        <!-- 分页导航 -->
        <nav class="pagination is-small is-centered" role="navigation" aria-label="pagination" style="margin: 0;">
          <a class="pagination-previous" @click="prevPage" :disabled="currentPage === 1">上一页</a>
          <a class="pagination-next" @click="nextPage" :disabled="currentPage === totalPages">下一页</a>
          <ul class="pagination-list">
            <template x-for="page in paginationItems" :key="page.value">
              <li>
                <template x-if="page.type === 'page'">
                  <a class="pagination-link" :class="{ 'is-current': page.value === currentPage }" @click="goToPage(page.value)" x-text="page.value"></a>
                </template>
                <template x-if="page.type === 'ellipsis'">
                  <span class="pagination-ellipsis">&hellip;</span>
                </template>
              </li>
            </template>
          </ul>
        </nav>

        <!-- 跳转页面 -->
        <div class="pagination-goto is-flex is-align-items-center" style="gap: 0.5rem;">
          <span>前往</span>
          <input class="input is-small" style="width: 60px;" type="number" min="1" :max="totalPages" x-model="goToPageInput">
          <span>页</span>
          <button class="button is-small" @click="goToPage(goToPageInput)">确定</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* 加载动画 */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .icon-loading {
    animation: spin 1s linear infinite;
  }
  
  .help.is-size-7 {
    font-size: 0.75rem;
  }
  
  .pagination-container {
    margin-top: 1rem;
  }
  
  .buttons.are-small .button {
    margin-bottom: 0;
  }
</style>

